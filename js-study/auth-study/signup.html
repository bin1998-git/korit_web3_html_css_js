<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./signup.css">
    <title>Document</title>
</head>
<body>
    <div class="signup-container">
        <h2 class="signup-title">회원가입</h2>
        <div class="form-group">
            <label for="username">아이디</label>
            <input type="text" id="username" placeholder="아이디 입력">
            <p class="error-message" id="usernameError"></p>
        </div>
         <div class="form-group">
            <label for="password">비밀번호</label>
            <input type="password" id="password" placeholder="패스워드 입력">
            <p class="error-message" id="passwordError"></p>
        </div>
         <div class="form-group">
            <label for="name">이름</label>
            <input type="text" id="name" placeholder="이름 입력">
            <p class="error-message" id="nameError"></p>
        </div>
         <div class="form-group">
            <label for="email">이메일</label>
            <input type="email" id="email" placeholder="이메일 입력">
            <p class="error-message" id="emailError"></p>
        </div>
        <button id="signupBtn" class="signup-btn">회원가입</button>
    </div>
</body>
<script>
    // dom요소들 가져오기
const usernameInput = document.querySelector("#username");
const passwordInput = document.querySelector("#password");
const nameInput = document.querySelector("#name");
const emailInput = document.querySelector("#email");

const signupBtn = document.querySelector("#signupBtn");
const errorMsgs = document.querySelectorAll(".error-message")

const signupReq = async () => {

    const usernameVal = usernameInput.value;
    const passwordVal = passwordInput.value;
    const nameVal = nameInput.value;
    const emailVal = emailInput.value;

    // 백엔드 dto 필드명과 key를 대응시켜 줘야 한다.
    let signupData = {
        username: usernameVal,
        password: passwordVal,
        name: nameVal,
        email: emailVal,
    };
    console.log(signupData);
    // JSON으로 변환해줘서 body에 주입
    signupData = JSON.stringify(signupData);


    // 서버로 회원가입 데이터 전송
    try {
         const response = await fetch("http://localhost:8080/auth/signup", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: signupData
    });


    // 200대 코드 내려왔을때
    if(response.ok) {
        alert("회원가입 성공!");
        return;
    }

    // validation 예외 응답
    if(response.status === 400) {
        // List<map<string, string>>
        const errorResData = await response.json();
        console.log(errorResData);

        const errorMap = {};
        for (let errorObj of errorResData) {
            // {username: dddd}
            let entires = Object.entries(errorObj);
            entires = entires[0]
            // ["username", "어쩌고"]
            // 비구조 할당
            const [field, message] = entires;
            // js객체에 필드 추가
            // 객체.필드명 = 필드값
            // 필드명에 변수에 담긴 값을 쓰고싶을땐?
            // 객체[변수] = 필드값
            errorMap[field] = message;
        }
        
        const errorFields = Object.keys(errorMap)
        for (let field of errorFields) {
            const errorMsgId = field + "Error";
            console.log(errorMsgId);
            const errorMsgSpan = document.querySelector(`#${errorMsgId}`);

            errorMsgSpan.innerText = errorMap[field];

            const input = document.querySelector(`#${field}`);
            input.value = "";
            input.focus();
        }



    }


    } catch (error) {
        console.log(error);
        alert("요청 중 문제가 발생했습니다.")
    }
    
    console.log(response);
    
}

signupBtn.addEventListener("click", signupReq)
</script>
</html>