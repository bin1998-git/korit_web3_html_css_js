<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./style.css">
    <title>Document</title>
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="logo">ShoppingMall</div>
            <div class="menu-area">
                <ul class="menu">
                    <li>TOP</li>
                    <li>OUTER</li>
                    <li>BOTTOM</li>
                    <li>ACC</li>
                </ul>
            </div>
            <!-- cart를 누르면 장바구니 모달이 열림 -->
            <div class="cart">장바구니</div>
        </nav>
    </header>
    <main>
        <!-- 상품카드들이 렌더링(js로) -->
        <section class="product-list"></section>
    </main>
    <div class="modal-overlay hidden">
        <div class="cart-modal">
            <div class="modal-header"></div>
            <h2>장바구니</h2>
            <button class="close-btn">x</button>
        </div>
            <ul>
                <!-- localstorge에 잇는 데이터로 렌더링 -->
            </ul>
            <div class="modal-footer">
                <button class="close-btn">x</button>
            </div>
    </div>
</body>
<script>
    // dom 요소들
    const productList = document.querySelector(".product-list");



    // 전역변수
    let productDataList = [];
    const BASE_URL = "https://fakestoreapi.com/products";

    // fetch로 데이터들을 productDataList에 담는 함수
    const loadProducts = async () => {
        const response = await fetch(BASE_URL);
        const result = await response.json();

        // 받아온 데이터를 상태변수에 저장
        productDataList = result;

        // 동기적으로 렌더링()
        renderProducts(productDataList);
        

    }

    // productDataList 데이터들을 기반으로 렌더링하는 함수
    const renderProducts = (productDataList) => {
        // 기존에 있던 HTML을 삭제(중복방지)
        productList.innerHTML = "";    
        
        let myHtml = "";
        // 상품 하나당 카드 하나 만들어서 붙혀줌
        for (let product of productDataList) {
            const cardHTML = createProductCardHTML(product);
            myHtml += cardHTML; 
        }

        productList.innerHTML = myHtml;
    }

   
    const createProductCardHTML = (product) => {
        const { image, title, price, id } = product;
        // 버튼을 누르면, product의 id를 추출할 수 있게
        // 전역에 잇는 ProductList에서 id로 해당 상품을 특정해
        // localstorage에 담아줄겁니다.
        const html = `
            <div class="product-card">
                <div class="image-box">
                    <img src="${image}" alt="${title}" />
                    </div>    
                <h3 class="title">${title}</h3>
                <p class="price">$${price}</p>
                <button data-productId="${id}">상품담기</button>
            </div>
        `;
        return html;
    }

    // productList안에 card들을 만들어 줬음
    // card안에 버튼에서 이벤트가 생성 -> 전파.. -> productList에서 감지
    productList.addEventListener("click", (e) => {
        // 버튼이 아니면 바로 리턴
        const target = e.target;
        console.log(target);
        const tagName = target.tagName;
        if (tagName !== "BUTTON") {
            return;
        }
        // 클릭한버튼의 data-productId를 가져와야함
        let productId = target.dataset.productId
        productId = parseInt(productId);

        //id로 productDataList에서 상품을 특정해서 가져옴(js객체)
        // let selectedProduct = {};
        // for (let product of productDataList) {
        //     if(product.id === productId) {
        //         selectedProduct = product;
        //         break;
        //     }
        // }

       selectedProduct = productDataList.find((product) => {
        return product.id === productId;
       });

       // 최초면, localstorage에 아무것도 없음
       const savedCart = localStorage.getItem("cart");

       // 최초면 falsy, 최초가아니면 truthy
       // 값 ? truthy일때값: falsy일때 값
       const cart = savedCart ? JSON.parse(savedCart) : [];

       // localstorage에 이미 상품이 존재한다면? 수량증가
       // 없다면 새로추가 -> cart에 해당 id의 상품이 있는지?
       const existingItem = cart.find((product) => {
        return product.id === selectedProduct.id
       });

       if(existingItem) { // cart에 이미 있다면!
        existingItem.count += 1;
       } else { //없다면 push
        const { id, title, price, image } = selectedProduct;
        const newItem = {
            id: id,
            title: title,
            price: price,
            image: image,
            count: 1
        }
         cart.push(newItem)
       }

       // 로컬스토리지에 저장
       const savingData = JSON.stringify(cart);
       localStorage.setItem("cart", savingData);
    });

    loadProducts();

</script>

</html>